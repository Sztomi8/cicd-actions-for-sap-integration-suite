# üîÑ XML Configuration Merger GitHub Action

Intelligently merge temporary XML configuration files with existing configuration while preserving environment-specific parameter values.

---

## ‚ú® Overview

This action performs intelligent XML configuration merging for integration flow parameters. It takes a temporary XML file (typically generated by parameter export operations), compares it with an existing configuration file, and merges them while preserving environment-specific parameter values (TST, PRD) from the existing configuration. The action uses Node.js and xml2js to parse, merge, and rebuild the XML structure, then cleans up temporary files and leaves the finalized configuration in place. Ideal for keeping parameter configurations synchronized across environments without losing environment-specific customizations.

---

## ‚öôÔ∏è Inputs

| Name          | Required | Description                                                              |
|---------------|----------|--------------------------------------------------------------------------|
| temp_xml_path | ‚úÖ Yes   | Full path to temporary XML file (e.g., `/path/to/ConfigParams_INTEGRATION_FLOW.xml.tmp`) |

---

## üìù Usage Example

```yaml
jobs:
  export-and-merge-parameters:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Get OAuth Token
        id: auth
        uses: ./.github/actions/get-oauth-token
        with:
          btp-api-user: ${{ secrets.BTP_API_USER }}
          btp-tec-user: ${{ secrets.BTP_TEC_USER }}
          btp-token-url: ${{ secrets.BTP_TOKEN_URL }}
          BTP_API_PASSWORD: ${{ secrets.BTP_API_PASSWORD }}
          BTP_TEC_PASSWORD: ${{ secrets.BTP_TEC_PASSWORD }}
      
      - name: Get Package IDs
        id: get-ids
        uses: ./.github/actions/get-object-ids-of-package
        with:
          bearer-token: ${{ steps.auth.outputs.token }}
          btp-api-url: ${{ secrets.BTP_API_URL }}
          package-id: my-package-001
          object-type: Integration
      
      - name: Export Parameters
        id: export
        uses: ./.github/actions/get-external-parameters
        with:
          bearer-token: ${{ steps.auth.outputs.token }}
          btp-api-url: ${{ secrets.BTP_API_URL }}
          package-id: my-package-001
          package-name: my-package
          file: ${{ steps.get-ids.outputs.file }}
      
      - name: Merge Parameters
        uses: ./.github/actions/xml-configuration-merger
        with:
          temp_xml_path: ${{ steps.export.outputs.path }}
      
      - name: Commit Changes
        uses: ./.github/actions/git-commit
        with:
          comment: "Update integration flow parameters"

  sync-and-preserve-env-values:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Get Token
        id: token
        uses: ./.github/actions/get-oauth-token
        with:
          btp-api-user: ${{ secrets.BTP_API_USER }}
          btp-tec-user: ${{ secrets.BTP_TEC_USER }}
          btp-token-url: ${{ secrets.BTP_TOKEN_URL }}
          BTP_API_PASSWORD: ${{ secrets.BTP_API_PASSWORD }}
          BTP_TEC_PASSWORD: ${{ secrets.BTP_TEC_PASSWORD }}
      
      - name: Get IFlow IDs
        id: iflows
        uses: ./.github/actions/get-object-ids-of-package
        with:
          bearer-token: ${{ steps.token.outputs.token }}
          btp-api-url: ${{ secrets.BTP_API_URL }}
          package-id: my-package-001
          object-type: Integration
      
      - name: Export Latest Parameters
        id: export-new
        uses: ./.github/actions/get-external-parameters
        with:
          bearer-token: ${{ steps.token.outputs.token }}
          btp-api-url: ${{ secrets.BTP_API_URL }}
          package-id: my-package-001
          package-name: my-package
          file: ${{ steps.iflows.outputs.file }}
      
      - name: Merge and Preserve Environment Values
        uses: ./.github/actions/xml-configuration-merger
        with:
          temp_xml_path: ${{ steps.export-new.outputs.path }}
      
      - name: Commit Updated Configuration
        uses: ./.github/actions/git-commit
        with:
          comment: "Sync parameters and preserve TST/PRD environment values"
```

---

## üìÇ Outputs

| Name             | Description                                  |
|------------------|----------------------------------------------|
| merged_file_path | Full path to the merged XML configuration file |

**Output File Details:**
- **Format**: `.xml` (replaces `.xml.tmp` extension)
- **Location**: Same directory as input file
- **Example**: `btp-insuite/IntegrationPackages/my-package~pkg-001/Configuration/ConfigParams_INTEGRATION_FLOW.xml`

**Merge Behavior:**
- Combines temporary XML data with existing configuration
- Preserves environment-specific values (`TST`, `PRD`) from existing file
- Keeps new/updated parameters from temporary file
- Returns formatted XML with proper indentation and declaration

---

## üí° Tips & Troubleshooting

- **File Naming Convention**: The action expects files following the pattern `*.xml.tmp`. The base filename (without extension) is used to locate existing configuration and generate the merged filename.

- **Merge Logic**: The action intelligently merges configurations by:
  1. Reading the temporary XML file (typically containing only `Default` parameter values)
  2. Locating the corresponding existing configuration file (if it exists)
  3. Matching artifacts by `ArtifactID` or `ArtifactName`
  4. Matching parameters by `ParameterKey`
  5. Preserving environment-specific values (`TST`, `PRD`) from existing configuration
  6. Combining data into a single merged XML file

- **Environment-Specific Values**: This action is designed to preserve environment-specific parameters:
  - `Default`: Always taken from temporary file (latest from BTP)
  - `TST`: Preserved from existing file if present
  - `PRD`: Preserved from existing file if present
  - Other environments: Can be manually added and will be preserved

- **First Run**: If no existing configuration file exists, the temporary XML becomes the merged configuration with only the `Default` values.

- **XML Structure**: The action expects XML following this structure:
  ```xml
  <PackageIntegrationFlowParameters>
    <Artifacts>
      <Artifact>
        <ArtifactID>flow-id</ArtifactID>
        <ArtifactName>Flow Name</ArtifactName>
        <Parameters>
          <Parameter>
            <ParameterKey>KEY</ParameterKey>
            <ParameterValues>
              <Default>value</Default>
              <TST>test-value</TST>
              <PRD>prod-value</PRD>
            </ParameterValues>
          </Parameter>
        </Parameters>
      </Artifact>
    </Artifacts>
  </PackageIntegrationFlowParameters>
  ```

- **Node.js Dependency**: The action automatically installs Node.js 18 and the xml2js npm package. No pre-installation required.

- **Temporary File Cleanup**: The action automatically deletes temporary files:
  1. Removes the original `.xml` file if it exists
  2. Renames `.xml.merged` to `.xml`
  3. Deletes the `.tmp` file
  4. Removes node_modules, package.json, package-lock.json, and merge script

- **File Verification**: The action verifies the merged file was created successfully and displays file size and first 10 lines for debugging.

- **Artifact Matching**: Artifacts are matched using either `ArtifactID` or `ArtifactName`. If multiple artifacts have similar names, use specific IDs for reliable matching.

- **Parameter Matching**: Parameters are matched by `ParameterKey`. Ensure parameter keys are consistent between runs for proper merging.

- **Array vs Single Element**: The action handles both single elements and arrays in XML (xml2js normalizes these). Single artifacts or parameters are handled the same as arrays.

- **XML Declaration**: The merged file includes proper XML declaration with UTF-8 encoding and is formatted with 2-space indentation.

- **Error Handling**: If the temporary file is not found, doesn't contain valid XML, or parsing fails, the action exits with a clear error message.

- **Workflow Integration**: Typically use this action after `get-external-parameters` to merge newly exported parameters with existing configurations before committing to Git.

- **Environment Values**: Manually edit the merged XML file to add or modify environment-specific values for `TST`, `PRD`, or other environments. These will be preserved in subsequent merges.

- **Backup**: The action overwrites existing configuration files. Consider committing the current configuration to Git before running this action if you need to preserve prior versions.

- **Git Workflow**: After merging, typically run `git-commit` action to commit the changes to your repository.

---

## üìÑ License

This project is licensed under the Apache License 2.0.